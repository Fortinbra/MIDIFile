<!DOCTYPE html>
<html manifest="application.manifest">
<head>
	<meta charset="utf-8" />
	<title>Sample Basic MIDI Player</title>
 <!-- WebMidiAPI polyfill -->
 <script src='http://cwilso.github.com/WebMIDIAPIShim/WebMIDIAPI.js'></script>
 <!-- MidiFile -->
 <script src="./../src/MIDIEvents.js" type="text/javascript"></script>
 <script src="./../src/MIDIFileTrack.js" type="text/javascript"></script>
 <script src="./../src/MIDIFileHeader.js" type="text/javascript"></script>
 <script src="./../src/MIDIFile.js" type="text/javascript"></script>
</head>
<body>
	<div class="app">
		<h1>MidiFile.js &amp; WEBMIDI API based MIDI player</h1>
		<h2>Test MidiFile.js</h2>
		<p>
			In order to test this MIDI player, you must download the
			<a href="http://jazz-soft.net/download/Jazz-Plugin/">Jazz Midi Plugin</a>.
		</p>
		<p>
			<label>Pick a MIDI file:
			<input type="file" onchange="readFile(this)" accept="audio/x-midi" /></label><br />
			<label>or choose one :
				<select onchange="downloadFile(this)">
					<option value=""></option>
					<option value="SampleMountainman.mid">SampleMountainman.mid</option>
					<option value="MIDIOkFormat0.mid">MIDIOkFormat0.mid</option>
					<option value="MIDIOkFormat1.mid">MIDIOkFormat1.mid</option>
					<option value="MIDIOkFormat2.mid">MIDIOkFormat2.mid</option>
					<option value="MIDIOkFormat1-lyrics.mid">MIDIOkFormat1-lyrics.mid</option>
					<option value="MIDIBadTrackHdr.mid">MIDIBadTrackHdr.mid</option>
					<option value="MIDIBadHeaderLength.mid">MIDIBadHeaderLength.mid </option>
					<option value="MIDIBadHeaderChunk.mid">MIDIBadHeaderChunk.mid</option>
					<option value="MIDIBadHeaderSMTPE.mid">MIDIBadHeaderSMTPE.mid</option>
					<option value="MIDIBadTrackLength.mid">MIDIBadTrackLength.mid</option>
					<option value="MIDIBadHeaderFormat.mid">MIDIBadHeaderFormat.mid</option>
					<option value="MIDIBadHeaderTracksNum.mid">MIDIBadHeaderTracksNum.mid</option>
				</select>
			</label>
		</p>
		<h2>Usefull</h2>
		<p>
			<a href="http://webaudio.github.io/web-midi-api/">WebMidi spec</a><br />
			<a href="http://cwilso.github.io/WebMIDIAPIShim/">WebMidi polyfill</a><br />
			<a href="http://www.sonicspot.com/guide/midifiles.html">Midi File Specs</a><br />
			<a href="http://www.onicos.com/staff/iz/formats/smf006.html">Midi File Specs + Samples</a><br />
			<a href="http://gnese.free.fr/Projects/KaraokeTime/Fichiers/karfaq.html">Kar File Specs</a><br />
			<a href="http://www.personal.kent.edu/~sbirch/Music_Production/MP-II/MIDI/midi_protocol.htm">Midi File Specs</a><br />
			<a href="http://en.wikipedia.org/wiki/General_MIDI">General MIDI overview</a><br />
			<a href="http://www.karaokar.com/index.php/telecharger/sound-fonts">Soundfonts bank</a><br />
			<a href="http://theremin.music.uiowa.edu/">Free sounds of complete scales for various instruments</a><br />
			<a href="http://www.midimountain.com/midi/midi_note_numbers.html">MIDI note numbers</a><br />
			<a href="http://home.roadrunner.com/~jgglatt/tech/midifile.htm">MIDI file format</a><br />
		</p>
	</div>
	<script type="text/javascript">
		var midiAccess;
		// Requesting Midi Access
		navigator.requestMIDIAccess().then( function onsuccesscallback( access ) {
		  midiAccess = access;
		},function onerrorcallback( err ) {
		  console.log("uh-oh! Something went wrong!  Error code: " + err.code );
		});

		// File handlers
		function readFile(input) {
			var reader = new FileReader();
			reader.readAsArrayBuffer(input.files[0]);
			reader.onloadend=function(event) {
				playFile(event.target.result);
   		}
   	}
		function downloadFile(input) {
			if(!input.value)
				return;
			var oReq = new XMLHttpRequest();
			oReq.open("GET", "../sounds/"+input.value, true);
			oReq.responseType = "arraybuffer";
			oReq.onload = function (oEvent) {
				playFile(oReq.response);
			};
			oReq.send(null);
   	}
   
   // file player
		var midiFile, m;
		function playFile(buffer) {
			var midiOutput;
			// testing output
			if(!midiAccess)
				throw new Error('No access to MIDI');
			var midiOutput=midiAccess.outputs()[0];
			// creating the MidiFile instance
			midiFile=new MIDIFile(buffer)
			// Reading events
			var events, event, tempo=500,
				startTime=playTime=window.performance.now(),
				format=midiFile.header.getFormat(),
				tickResolution=midiFile.header.getTickResolution();
			// Reading each track
			for(var i=0, j=midiFile.tracks.length; i<j; i++) {
				// play start time (if format==2, play tracks sequentially)
				playTime=(2==format&&playTime?playTime:window.performance.now());
				events=new MIDIEvents.createParser(midiFile.tracks[i].getTrackEvents(),0,false);
				// loooping throught events
				while(event=events.next()) {
					// tempo change events
					if(event.type===MIDIEvents.EVENT_META
						&&event.subtype===MIDIEvents.EVENT_META_SET_TEMPO) {
						tickResolution=midiFile.header.getTickResolution(event.tempo);
					// play midi events
					} else if(event.type===MIDIEvents.EVENT_MIDI) {
						midiOutput.send(
							[(event.subtype<<4)+event.channel, event.param1, (event.param2||0x00)],
							playTime+=(event.delta*tickResolution));
					}
				}
			}
			console.log('Events sent. playTime: '+playTime+', Tracks:'+midiFile.tracks.length);
   	}
	</script>
</body>
</html>
